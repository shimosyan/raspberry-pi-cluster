# Proxmox Cluster Setup

Proxmox にログインします。

## アップデート

### リポジトリの設定

左側のサーバーツリーから物理マシンを選択して、ダッシュボードから`アップデート`→`リポジトリ`を開きます。

`APIリポジトリ`の`追加`をクリックします。

リポジトリ追加ウィンドウが開くので `No-Subscription` を選択して追加します。

### アップデートの設定

左側のサーバーツリーから物理マシンを選択して、ダッシュボードから`アップデート`を開きます。

`再表示`ボタンを押すとログイン時と同じく有効なサブスクリプション契約がない旨のメッセージが表示されるものの無視してOKボタンを押します。

すると `apt-get update` 処理がログ画面に表示されます。

ログに `TASK OK` と表示されたら 右上の×ボタンを押して閉じます。

#### もし GPG error が起きたら

リポジトリのキーが `apt` のkeyマネージャーに信頼されていないことが原因です。

Proxmox のダッシュボード右上にある「シェル」を開き、以下のコマンドで登録すれば解決できます。

`KEY_ID` にはエラーテキストにある `NO_PUBKEY` の右側の文字列を使用してください。

```sh
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys KEY_ID
```

### アップデートの実行

左側のサーバーツリーから物理マシンを選択して、ダッシュボードから`アップデート`を開きます。

`アップグレード` ボタンを押すと別ウィンドウが開き、コンソールで `apt-get dist-upgrade` 処理が走り、続行してよいか聞かれるので `y` ボタンを押下。

アップグレードが完了しても自動的にウィンドウは閉じません。自分で閉じます。

カーネル更新がある場合は、再起動が必要です。

リブートコマンドをたたくなり上部メニューの再起動ボタンを押して再起動します。

## ストレージの追加

### NAS の設定

iSCSI で接続します。

Synology の NAS からパッケージマネージャー経由で、`SAN Manager` をインストールします。

`SAN Manager` を開いて、新規 LUN を作成します。使用できる容量はここで指定できます。

作成した LUN に対して、iSCSI Target を割り当てます。

### Proxmox の設定

ダッシュボードから`ストレージ`を開きます。

追加メニューから `iSCSI` を指定します。

設定ダイアログが表示されるので以下の通りに入力します。

- ID: 識別しやすい任意の文字列
- Portal: NAS の IP アドレス
- Target: NAS で設定した iSCSI Target の IQN

ここまで入力して OK をクリックします。

次に iSCSI 用のパッケージをインストールします。

Proxmox のダッシュボード右上にある「シェル」を開き、以下のコマンドを実行します。

```sh
apt install open-iscsi
```

インストールが終わったら Proxmox のダッシュボード右上にある「再起動」ボタンを実行します。

## クラスターの作成

ダッシュボードから`クラスタ`を開きます。

`クラスタ未定義`となっているはずなので、「クラスタを作成」をクリックします。

Cluster Name にクラスタ名「`raspi-cluster`」を入力します。

この名前は後から変更することが出来ませんので、慎重に決める必要があります。

Cluster Network には設定している Raspberry PI の IP アドレスを指定して作成を実行します。

実行ログが表示され `TASK OK` と表示されたら完了です。

クラスタ画面の `JOIN 情報` には2台目以降の Proxmox をクラスターに登録させるために必要なパラメータが記載されています。
