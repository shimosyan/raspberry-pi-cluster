# Virtual Machine Manual Setup

この手順は VM を手動でセットアップするための方法です。

本環境では主に LXC を使用するため普段は使用しません。

## OS イメージの追加

### OS イメージのダウンロード

Ubuntu の公式サイトから [arm64 向けのインストールイメージ](https://ubuntu.com/download/server/arm)のダウンロード URL を入手します。amd64 は使用できないので注意してください。

## OS イメージの登録

イメージ URL が入手できたら、Proxmox のいずれかノードから `synology-nfs` ストレージを開きます。

ストレージメニューに `ISOイメージ` があるのでこれを開くと「URL からダウンロード」ボタンがあります。

これをクリックすると、URL の入力ダイアログが表示されるので、先の手順で入手した ISO のダウンロード URL を入力します。

入力が終わったら「クエリURL」をクリックします。ファイル名称などの情報が得られるので、問題なければ「ダウンロード」を実行します。

## Virtual Machine の準備

ダッシュボード右上の「VMを作成」をクリックします。

作成ウィンドウが立ち上がるので、以下の通りに入力します。指定ないものはデフォルト値のままにします。

太字の箇所は指示通りに入力しないと起動しません。

|カテゴリー|項目|値|
|---|---|---|
|全般|ノード|VM を設置したいノード|
|全般|VM ID|デフォルトのまま|
|全般|名前|任意の名前を入力。このあとサーバーのホスト名にも使用します。|
|OS|メディアを使用しない|ON|
|システム|BIOS|**OVMF (UEFI)**|
|システム|EFI Storage|**NAS を選択**|
|システム|ディスクイメージ|**NAS 上に作成した LUN を選択** 別の VM と重複しないようにしてください。|
|システム|Qemuエージェント|ON|
|ディスク|ストレージ|**NAS を選択**|
|ディスク|ディスクイメージ|**NAS 上に作成した LUN を選択** システム-ディスクイメージで指定した LUN と同じものを指定してください。|
|CPU|ソケット|お好みで。1がオススメ|
|CPU|コア|お好みで。2がオススメ|
|CPU|種別|host|
|メモリ|容量|お好みで。|

### Virtual Machine の修正

#### ハードウェアの設定

このままでは起動しません。いくつか変更が必要です。

作成した VM のハードウェアページを開いて、既存の `CD/DVD Drive(ide*)` を削除します。

次に、追加メニューから「CD/DVD ドライブ」をクリックします。

設定ウィンドウが表示されるので、次のように入力してOKをクリックします。

|項目|値|
|---|---|
|バス/デバイス|SCSI 2|
|ストレージ|local|
|ISO イメージ|上記手順で登録した ubuntu の ISO イメージ|

#### ブート順の設定

作成した VM のオプションページを開きます。

一覧の中に「ブート順」があるので、これを `DVD, HDD` の順に変更します。

## Virtual Machine の起動

VM の概要ページ右上から「開始」を実行します。

無事起動ができたら、VM の概要ページ右上から「コンソール」をクリックすると VM の画面を表示できます。

初回起動の際は `BdsDxe: failed to load Boot****` と表示されますが、しばらく放っておいて問題ありません。

しばらくすると、Ubuntu のインストーラーがブートされるので、`Try or Install Ubuntu` を選びます。

「Display output is not active.」と表示できる画面がないメッセージになりますが、しばらく放っておいて問題ありません。

### Ubuntu のセットアップ

またしばらくすると、Ubuntu のセットアップ画面になります。次のように進めます。

- 言語設定：日本語はプリインストールされていないため `English` を選択します。
- キーボード設定：ここでは `Japanese` を選択します。
- インストールタイプ：ここでは `Ubuntu Server` を選択します。
- ネットワーク設定：IPアドレスを指定します。
  - IPv4：マニュアルで設定します。
    - Subnet: `192.168.6.0/24`
    - Address: サーバーに割り振りたい固定IP
    - Gateway: `192.168.6.1`
    - Name servers: `192.168.2.1`
  - IPv6：無効にします。
- プロキシサーバー：なにもせず次に進みます。
- アーカイブミラーサーバー：デフォルトのまま次に進みます。
- ストレージ設定：デフォルトのままにします。

ここまで進めると、ディスクの初期化の確認画面になるので「Continue」を実行します。

サーバーのホスト名、ユーザーID、パスワードを設定する画面になります。以下のように入力します。

|項目|値|
|---|---|
|Tour name|空白|
|Your server's name|Proxmox で設定した VM 名|
|Pick a username|`owner`|
|パスワード|username のパスワード|

次に Upgrade to Ubuntu Pro の画面になりますがスキップします。

SSH のセットアップになります。OpenSSH はインストールするようにします。

最後に追加パッケージの選択画面になりますが、何も選択しません。

これまで選択した内容でセットアップが始まります。

完了したら再起動を求められます。

## 参考資料

- <https://github.com/pimox/pimox7/blob/master/docs/VM-Configuration.md>
- <https://qiita.com/wancom/items/b62ac44e6c9f0d1c4048#vm%E3%82%92%E4%BD%9C%E6%88%90%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B>
- <https://zenn.dev/hatotk/articles/install-ubuntu-server-20-04-lts>
