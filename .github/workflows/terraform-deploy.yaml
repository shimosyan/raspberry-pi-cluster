name: Terraform Deploy
on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/pull-request.yaml
      - .github/workflows/terraform**
      - .github/workflows/wc-terraform**
      - tfaction-root.yaml
      - proxmox/**
      - aqua.yaml

concurrency:
  group: terraform-deploy # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆãŒ1ã¤ã—ã‹ãªã„ãŸã‚ repo å†…ã§æ’ä»–åˆ¶å¾¡
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read
  pull-requests: write
  actions: read # artifact ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«å¿…è¦

env:
  TFACTION_TARGET: proxmox
  TFACTION_WORKING_DIR: proxmox
  TFACTION_JOB_TYPE: terraform
  TFACTION_IS_APPLY: "true"

jobs:
  terraform-apply:
    environment: production
    runs-on: ubuntu-latest

    env:
      PM_HTTP_HEADERS: CF-Access-Client-Id,${{ secrets.CF_ACCESS_CLIENT_ID }},CF-Access-Client-Secret,${{ secrets.CF_ACCESS_CLIENT_SECRET }}

    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - id: app-token
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - uses: aquaproj/aqua-installer@11dd79b4e498d471a9385aa9fb7f62bb5f52a73c # v4.0.4
        with:
          aqua_version: v2.55.1
        env:
          AQUA_GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      # GitHub Secrets ã‚’ TFAction ã«æ¸¡ã™ Action
      - uses: suzuki-shunsuke/tfaction/js@4562d910bbacecf384c8aeda25332284fcf05f38 # v1.20.1
        with:
          action: export-secrets
          secrets: ${{ toJSON(secrets) }}

      - run: tfaction get-or-create-drift-issue
        # CHECK: You can remove this step if you don't use drift detection
        shell: bash
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      # terraform init ãªã©ã®æº–å‚™ã‚’è¡Œã† Action
      - uses: suzuki-shunsuke/tfaction/setup@4562d910bbacecf384c8aeda25332284fcf05f38 # v1.20.1
        with:
          github_token: ${{ steps.app-token.outputs.token }}
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      # terraform apply ã‚’å®Ÿè¡Œã™ã‚‹ Action
      - uses: suzuki-shunsuke/tfaction/apply@4562d910bbacecf384c8aeda25332284fcf05f38 # v1.20.1
        id: deploy
        with:
          github_token: ${{ steps.app-token.outputs.token }}
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      - uses: suzuki-shunsuke/tfaction/create-follow-up-pr@4562d910bbacecf384c8aeda25332284fcf05f38 # v1.20.1
        if: failure()
        with:
          github_token: ${{ steps.app-token.outputs.token }}

      - uses: suzuki-shunsuke/tfaction/update-drift-issue@4562d910bbacecf384c8aeda25332284fcf05f38 # v1.20.1
        # CHECK: You can remove this step if you don't use drift detection
        if: always()
        with:
          status: ${{job.status}}
          github_token: ${{ steps.app-token.outputs.token }}

  extract-created-lxc:
    environment: production
    runs-on: ubuntu-latest

    outputs:
      lxc_vm_list: ${{ steps.extract.outputs.lxc_vm_list }}

    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - id: app-token
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - uses: aquaproj/aqua-installer@11dd79b4e498d471a9385aa9fb7f62bb5f52a73c # v4.0.4
        with:
          aqua_version: v2.55.1
        env:
          AQUA_GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      # GitHub Secrets ã‚’ TFAction ã«æ¸¡ã™ Action
      - uses: suzuki-shunsuke/tfaction/js@4562d910bbacecf384c8aeda25332284fcf05f38 # v1.20.1
        with:
          action: export-secrets
          secrets: ${{ toJSON(secrets) }}

      # terraform init ã‚„å¿…è¦ãªç’°å¢ƒå¤‰æ•°ãªã©ã®æº–å‚™ã‚’è¡Œã† Action
      - uses: suzuki-shunsuke/tfaction/setup@4562d910bbacecf384c8aeda25332284fcf05f38 # v1.20.1
        with:
          github_token: ${{ steps.app-token.outputs.token }}
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      # Applyå¾Œã«PRã®plan artifactã‚’å–å¾—ï¼ˆJSONç‰ˆï¼‰
      - name: Download Plan Artifact
        run: |
          echo "=== Downloading Plan Artifact from PR ==="

          # tfactionç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨
          echo "Configuration:"
          echo "  Branch: $CI_INFO_HEAD_REF"
          echo "  Target: $TFACTION_TARGET"
          echo "  Has PR: $CI_INFO_HAS_ASSOCIATED_PR"

          # å¿…é ˆãƒã‚§ãƒƒã‚¯
          if [ "$CI_INFO_HAS_ASSOCIATED_PR" != "true" ] || [ -z "$CI_INFO_HEAD_REF" ]; then
            echo "âŒ No associated PR found or missing branch info"
            exit 1
          fi

          # plan workflowåã‚’å–å¾—
          PLAN_WORKFLOW_NAME=$(yq eval '.plan_workflow_name' tfaction-root.yaml)

          # tfactionã®å®Ÿè£…ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆJSONç‰ˆï¼‰
          branch=$CI_INFO_HEAD_REF
          artifact_name=terraform_plan_json_${TFACTION_TARGET//\//__}

          echo "Searching for plan from branch '$branch'..."

          # æœ€æ–°ã®æˆåŠŸã—ãŸworkflow runã‚’å–å¾—
          body=$(gh run list \
            --repo "${{ github.repository }}" \
            -w "$PLAN_WORKFLOW_NAME" \
            -b "$branch" \
            -L 1 \
            --json headSha,databaseId,conclusion \
            --jq '.[0]')

          if [ -z "$body" ] || [ "$body" = "null" ]; then
            echo "âŒ No workflow runs found for branch '$branch'"
            exit 1
          fi

          run_id=$(echo "$body" | jq -r ".databaseId")
          conclusion=$(echo "$body" | jq -r ".conclusion")

          if [ "$conclusion" != "success" ]; then
            echo "âŒ Workflow run $run_id was not successful: $conclusion"
            exit 1
          fi

          echo "âœ… Found successful workflow run: $run_id"

          # JSON artifactã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          mkdir -p ./plan-artifacts

          if gh run download \
            --repo "${{ github.repository }}" \
            -D "./plan-artifacts" \
            -n "$artifact_name" \
            "$run_id"; then

            echo "âœ… Successfully downloaded plan artifact"

            # ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
            if [ -f "./plan-artifacts/tfplan.json" ]; then
              echo "âœ… Plan JSON verified: $(wc -c < ./plan-artifacts/tfplan.json) bytes"
            else
              echo "âŒ Expected tfplan.json not found"
              ls -la ./plan-artifacts/
              exit 1
            fi
          else
            echo "âŒ Failed to download artifact: $artifact_name"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      # Plan JSONã‹ã‚‰LXC VM IDã‚’æŠ½å‡º
      - name: Extract Created LXC VM ID
        id: extract
        run: |
          echo "=== Extracting LXC VM IDs from Plan Artifacts ==="

          if [ -f "./plan-artifacts/tfplan.json" ]; then
            echo "âœ… Found plan JSON artifact: ./plan-artifacts/tfplan.json"

            # Plan JSONã‹ã‚‰æ–°è¦ä½œæˆã•ã‚Œã‚‹LXCãƒªã‚½ãƒ¼ã‚¹ã‚’ç›´æ¥JSONé…åˆ—ã¨ã—ã¦æŠ½å‡º
            echo "Analyzing plan for new LXC resources..."

            # ãƒ‡ãƒãƒƒã‚°: ã¾ãšãƒªã‚½ãƒ¼ã‚¹å¤‰æ›´å…¨ä½“ã‚’ç¢ºèª
            echo "=== Resource changes in plan ==="
            jq '.resource_changes[] | select(.type == "proxmox_lxc") | {address: .address, actions: .change.actions}' "./plan-artifacts/tfplan.json" || echo "No LXC resources found"

            # JSONé…åˆ—ã¨ã—ã¦ç›´æ¥ä½œæˆ
            LXC_VM_LIST=$(jq -c '
              [.resource_changes[]
              | select(.type == "proxmox_lxc" and (.change.actions[] == "create"))
              | {
                  id: (.change.after.vmid | tostring),
                  resource: (.address | sub("proxmox_lxc\\."; "") | sub("\\[.*\\]"; ""))
                }]
            ' "./plan-artifacts/tfplan.json")

            # ç©ºé…åˆ—ãƒã‚§ãƒƒã‚¯
            if [ "$LXC_VM_LIST" = "[]" ] || [ -z "$LXC_VM_LIST" ]; then
              echo "â„¹ï¸ No new LXC containers found in plan artifact"
              echo "lxc_vm_list=[]" >> "$GITHUB_OUTPUT"
            else
              echo "ğŸ†• New LXC containers found:"
              echo "$LXC_VM_LIST" | jq -r '.[] | "- VM ID: \(.id), Resource: \(.resource)"'

              echo "âœ… New LXC VM List: $LXC_VM_LIST"
              echo "lxc_vm_list=$LXC_VM_LIST" >> "$GITHUB_OUTPUT"
            fi

          else
            echo "âŒ Plan JSON artifact not found"
            echo "lxc_vm_list=[]" >> "$GITHUB_OUTPUT"
            exit 1
          fi


  # Extract Create LXC ã§å‡ºåŠ›ã—ãŸ lxc_vm_list ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã¨ãã ã‘å®Ÿè¡Œã™ã‚‹
  ansible-for-proxmox-lxc:
    needs:
      - terraform-apply
      - extract-created-lxc
    if: needs.extract-created-lxc.outputs.lxc_vm_list != '[]' && needs.extract-created-lxc.outputs.lxc_vm_list != ''
    runs-on: [self-hosted, proxmox-ansible]

    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Get Script List
        id: get-script-list
        run: |
          HOST_FILE=$(ls -F ./host  | grep -v / | sed "s/*//g")
          CONTAINER_FILE=$(ls -F ./container  | grep -v / | sed "s/*//g")

          HOST_FILE_LIST=$(echo "$HOST_FILE" |  tr '\n' ',' |  sed -e 's/,$/\n/g')
          CONTAINER_FILE_LIST=$(echo "$CONTAINER_FILE" |  tr '\n' ',' |  sed -e 's/,$/\n/g')

          echo -n "HOST_FILE_LIST = $HOST_FILE_LIST"
          echo -n "CONTAINER_FILE_LIST = $CONTAINER_FILE_LIST"

          echo "HOST_FILE_LIST=$HOST_FILE_LIST" >> $GITHUB_OUTPUT
          echo "CONTAINER_FILE_LIST=$CONTAINER_FILE_LIST" >> $GITHUB_OUTPUT

        working-directory: scripts/lxc

      - name: Run Playbook
        run: |
          ansible-playbook playbook-proxmox-lxc.yaml --extra-vars 'lxc_vm_id="${{ env.LXC_VM_LIST }}" host_script_file="${{ env.HOST_FILE_LIST }}" container_script_file="${{ env.CONTAINER_FILE_LIST }}"'
        working-directory: ansible
        env:
          LXC_VM_LIST: ${{needs.extract-created-lxc.outputs.lxc_vm_list}}
          HOST_FILE_LIST: ${{steps.get-script-list.outputs.HOST_FILE_LIST}}
          CONTAINER_FILE_LIST: ${{steps.get-script-list.outputs.CONTAINER_FILE_LIST}}

  success:
    needs:
      - terraform-apply
      - extract-created-lxc
      - ansible-for-proxmox-lxc
    if: ${{ always() }}
    runs-on: ubuntu-latest

    steps:
      - name: Check job result
        run: |
          RESULT="${{ needs.terraform-apply.result }}"
          if [[ $RESULT != "success" && $RESULT != "skipped" ]]; then
            echo "This workflow failed or was cancelled!"
            exit 1
          fi

          RESULT="${{ needs.extract-created-lxc.result }}"
          if [[ $RESULT != "success" && $RESULT != "skipped" ]]; then
            echo "This workflow failed or was cancelled!"
            exit 1
          fi

          RESULT="${{ needs.ansible-for-proxmox-lxc.result }}"
          if [[ $RESULT != "success" && $RESULT != "skipped" ]]; then
            echo "This workflow failed or was cancelled!"
            exit 1
          fi

          echo "Success!!"
          exit 0
